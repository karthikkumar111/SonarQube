#!/bin/bash

# Shell script to install Java and set up SonarQube on Amazon Linux

# Exit on error
set -e

# Step 1: Install Java
echo "Installing Java..."
sudo amazon-linux-extras install java-openjdk11 -y

# Step 2: Move to /opt directory
echo "Changing to /opt directory..."
cd /opt

# Step 3: Download SonarQube
echo "Downloading SonarQube..."
sudo wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-9.9.5.90363.zip

# Step 4: Unzip SonarQube
echo "Unzipping SonarQube..."
sudo unzip sonarqube-9.9.5.90363.zip

# Step 5: Rename folder
echo "Renaming SonarQube folder..."
sudo mv sonarqube-9.9.5.90363 sonar

# Step 6: Create a user named 'sonar'
echo "Creating sonar user..."
sudo useradd sonar || echo "User 'sonar' may already exist"

# Step 7: Change ownership to sonar user
echo "Changing ownership to sonar user..."
sudo chown -R sonar:sonar /opt/sonar

# Step 8: Set full permissions (not recommended in production)
echo "Setting permissions to 777 (not secure for production)..."
sudo chmod -R 777 /opt/sonar

# Step 9: Switch to sonar user and start SonarQube
echo "Switching to sonar user and starting SonarQube..."
sudo -u sonar bash -c "
cd /opt/sonar/bin/linux-x86-64
./sonar.sh start
./sonar.sh status
"

echo "SonarQube setup complete."
